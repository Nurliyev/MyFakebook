{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css'>
    <link rel="stylesheet" href="{% static 'css/messanger.css' %}">
    <title>MyChat</title>
</head>
<body>

<nav class="navbar sticky-top navbar-light" style="background-color: #eaecec">
    <div class="container-fluid">
        <div class="col-sm-8">
            <a class="navbar-brand" href="home.html">
                <img src="{% static 'img/F.svg' %}" alt="" width="30" height="24" class="d-inline-block align-text-top">
                fakebook
            </a>
        </div>
        <div class="col-sm-4">
            <a class="navbar-brand" href="#">
                <i class="fi-rr-user" style="float: right;margin-top: 4px ;font-size: 30px;display: none"></i>
            </a>
            <a class="navbar-brand" href="#">
                <i class="fi-rr-bell" style="float: right;margin-top: 4px; margin-right: 20px ;font-size: 30px"></i>
            </a>
        </div>
    </div>
</nav>

<nav class="navbar fixed-bottom navbar-light" style="background-color: #eaecec">
    <div class="container-fluid  justify-content-center">
        <a class="navbar-brand" href="{% url 'post-list' %}">
            <i class="fi-sr-home" style="font-size: 30px"></i>
        </a>
    </div>
</nav>

<div id="chat-body">
    <div id="chat-container">
        <div id="search-container">
        </div>
        <div id="conversation-list">
            {% for room in rooms %}
                {% if room.Messages.all.count > 0 %}
                    {% if room.UserOne != request.user %}
                        <a href="{% url 'chatroom' room.UserOne.id %}">
                            <div class="conversation {% if room == target_room %}active{% endif %}">
                                <img src="{{ room.UserOne.avatar.url }}"
                                     alt="">
                                <div class="tittle-text">

                                    {{ room.UserOne.username }}

                                </div>
                                <div class="created-date">
                                    {{ room.Messages.last.date_created }}
                                </div>
                                <div class="conversation-message">
                                    {{ room.Messages.all.last.message_text }}
                                </div>
                            </div>
                        </a>
                    {% else %}
                        <div class="conversation">
                            <img src="{{ room.UserTwo.avatar.url }}"
                                 alt="">
                            <div class="tittle-text">
                                <a href="profile.html">
                                    {{ room.UserTwo.username }}
                                </a>
                            </div>
                            <div class="created-date">
                                {{ room.Messages.last.date_created }}
                            </div>
                            <div class="conversation-message">
                                {{ room.Messages.all.last.message_text }}
                            </div>
                        </div>
                    {% endif %}

                {% endif %}
            {% endfor %}
        </div>

        <div id="new-message-container">

        </div>

        <div id="chat-tittle">
            <a href="profile.html"><img src="{{ other_user.avatar.url }}"><span>{{ other_user.username }}</span></a>
            <!-- <a href="messanger.html"><img src="{% static 'img/delete.svg' %}"></a> -->
        </div>

        <div class="messages-area" id="chat-message-list">
            {% for message in messages %}
                <div class="message-row {% if message.SenderUser == request.user %}your-message{% else %}other-message{% endif %}">
                    <div class="message-content">
                        <div class="message-text">
                            {{ message.message_text }}
                        </div>
                        <div class="message-time">
                            {{ message.date_created }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="chat-form">
            <a href="" style="text-decoration: none;color: black"><i class="fi-rr-file-add" style="font-size: 20px"></i></a>
            <div class="input-area">
                <input type="text" id="message-input">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    let message_send_btn = document.getElementById("send-btn");
    let message_input = document.getElementById("message-input");
    let last_messages = document.querySelector(".messages-area");

    last_messages.scrollTop = last_messages.scrollHeight;

    function send_message() {
        let message = message_input.value;
        if (message === "") {
            return;
        }
        message_input.value = "";
        fetch("{% url 'chatroom-ajax' other_user.id %}",
            {
                method: "POST",
                credentials: 'same-origin',
                headers: {
                    "Content-Type": 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(message)
            }
        ).then(e => e.json()).then(messages => {
            for (message of messages) {
                construct_message(message);
            }
        });
    }

    function load_messages() {
        fetch("{% url 'chatroom-ajax' other_user.id %}")
            .then(e => e.json())
            .then(messages => {
                for (message of messages) {
                    construct_message(message);
                }
            })
    }

    function escapeHTML(unsafe_str) {
        return unsafe_str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#39;')
            .replace(/\//g, '&#x2F;')
    }

    function construct_message(message) {
        let messages_container = document.querySelector(".messages-area");
        let class_name = "other-message"
        if (message.sent) {
            class_name = "your-message"
        }
        let newdiv = '<div class="message-content"> <div class="message-text">' + escapeHTML(message.message) + '</div> <div class="message-time">' + message.date_day + ' ' + message.date_month + ' ' + message.date_year + ' Ð³. ' + message.date_hour + ':' + message.date_minute + '</div> </div>'
        let div = document.createElement("div");
        div.classList.add("message-row", class_name);
        div.innerHTML = newdiv
        messages_container.appendChild(div);
        div.scrollIntoView()
    }

    message_send_btn.addEventListener('click', send_message);
    setInterval(load_messages, 2000);
</script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
        integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
        integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
        crossorigin="anonymous"></script>
</body>
</html>